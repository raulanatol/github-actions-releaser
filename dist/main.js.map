{"version":3,"sources":["../src/main.ts","../src/models.ts","../src/issueTypeClassifier.ts","../src/releaseNotes.ts","../src/createRelease.ts"],"sourcesContent":["import * as core from '@actions/core';\nimport { releaseNotes } from './releaseNotes';\nimport { context, getOctokit } from '@actions/github';\nimport { createRelease } from './createRelease';\n\nconst getGithubClient = () => {\n  const githubToken = process.env.GITHUB_TOKEN;\n  if (!githubToken) {\n    throw new Error('Invalid GITHUB_TOKEN');\n  }\n  return getOctokit(githubToken).rest;\n};\n\nconst initialize = ({ repo, owner }) => ({ github: getGithubClient(), repo, owner });\n\nconst canCreateRelease = (): boolean => {\n  const noCreateRelease = core.getInput('NO_CREATE_RELEASE');\n  return noCreateRelease !== 'true';\n};\n\nasync function run(): Promise<void> {\n  try {\n    const init = initialize(context.repo);\n    const github = init.github;\n    const notes = await releaseNotes(github, init.repo, init.owner);\n    core.debug(`Notes: ${notes}`);\n    core.setOutput('notes', notes);\n    if (canCreateRelease()) {\n      await createRelease(github, context, notes);\n    }\n  } catch (error: any) {\n    core.setFailed(error.message);\n  }\n}\n\nrun().catch(console.error);\n","export const BUG_LABELS: string[] = ['bug', 'type: bug'];\n\nexport const FEATURE_LABELS: string[] = [\n  'enhancement',\n  'type: enhancement',\n  'feature',\n  'type: feature',\n];\n\nexport const FEATURE_TITLE_STARTS: string[] = ['feat:', 'feat(', 'feat '];\n\nexport const BUG_TITLE_STARTS: string[] = ['fix:', 'fix(', 'fix '];\n\nexport const TEST_TITLE_STARTS: string[] = ['test:', 'test(', 'test '];\n\nexport const TOOLS_TITLE_STARTS: string[] = ['chore:', 'chore(', 'chore '];\n\nexport const DOCS_TITLE_STARTS: string[] = ['docs:', 'docs(', 'docs '];\n\nexport type IssueType = 'feature' | 'bug' | 'test' | 'tools' | 'docs' | 'other';\n\nexport interface IssueToRelease {\n  id: number;\n  title: string;\n  url: string;\n  user: string;\n  type: IssueType;\n}\n\nexport interface ReleaseNotesIssuesText {\n  bugs: string;\n  features: string;\n  others: string;\n  enhancements: string;\n}\n\nexport type GitHubIssueLabel =\n  | string\n  | {\n      name?: string;\n      description?: string | null;\n\n      [key: string]: any;\n    };\n\nexport interface GitHubUser {\n  login: string;\n\n  [key: string]: any;\n}\n\nexport interface GitHubIssue {\n  id: number;\n  // node_id: string;\n  url: string;\n  // repository_url: string;\n  // labels_url: string;\n  // comments_url: string;\n  // events_url: string;\n  html_url: string;\n  // number: number;\n  // state: string;\n  title: string;\n  // body?: string;\n  user: GitHubUser | null;\n  labels: GitHubIssueLabel[];\n  // assignee: any;\n  // assignees: any[];\n  // milestone: any;\n  // locked: boolean;\n  // active_lock_reason: string;\n  // comments: 0;\n  // pull_request: any;\n  // closed_at: string;\n  // created_at: string;\n  // updated_at: string;\n  // author_association: any;\n\n  [key: string]: any;\n}\n\nexport interface GitHubPullRequest {\n  id: number;\n  html_url: string;\n  title: string;\n  number: number;\n  user: GitHubUser | null;\n  labels: GitHubIssueLabel[] | null;\n}\n","import {\n  BUG_LABELS,\n  BUG_TITLE_STARTS,\n  DOCS_TITLE_STARTS,\n  FEATURE_LABELS,\n  FEATURE_TITLE_STARTS,\n  GitHubIssue,\n  GitHubIssueLabel,\n  GitHubPullRequest,\n  IssueType,\n  TEST_TITLE_STARTS,\n  TOOLS_TITLE_STARTS,\n} from './models';\n\nexport const classifyIssue = (issue: GitHubIssue | GitHubPullRequest): IssueType => {\n  const typeFromLabels = getIssueTypeFromLabels(issue);\n  if (typeFromLabels) {\n    return typeFromLabels;\n  }\n\n  const typeFromTitle = getIssueTypeFromTitle(issue);\n  if (typeFromTitle) {\n    return typeFromTitle;\n  }\n\n  return 'other';\n};\n\nconst extractLabels = (labels: GitHubIssueLabel[]): string[] =>\n  labels.map((label) => {\n    if (typeof label === 'string') {\n      return label.toLowerCase();\n    }\n    return (label.name || '').toLowerCase();\n  });\n\nconst getIssueTypeFromLabels = (issue: GitHubIssue | GitHubPullRequest): IssueType | undefined => {\n  const labels = extractLabels(issue.labels || []);\n\n  for (const label of labels) {\n    if (BUG_LABELS.includes(label)) {\n      return 'bug';\n    }\n\n    if (FEATURE_LABELS.includes(label)) {\n      return 'feature';\n    }\n  }\n};\n\nconst getIssueTypeFromTitle = (issue: GitHubIssue | GitHubPullRequest): IssueType | undefined => {\n  const issueTitle = issue.title.toLowerCase();\n\n  for (const title of BUG_TITLE_STARTS) {\n    if (issueTitle.startsWith(title)) {\n      return 'bug';\n    }\n  }\n\n  for (const title of FEATURE_TITLE_STARTS) {\n    if (issueTitle.startsWith(title)) {\n      return 'feature';\n    }\n  }\n\n  for (const title of TEST_TITLE_STARTS) {\n    if (issueTitle.startsWith(title)) {\n      return 'test';\n    }\n  }\n\n  for (const title of TOOLS_TITLE_STARTS) {\n    if (issueTitle.startsWith(title)) {\n      return 'tools';\n    }\n  }\n\n  for (const title of DOCS_TITLE_STARTS) {\n    if (issueTitle.startsWith(title)) {\n      return 'docs';\n    }\n  }\n};\n","import { GitHubIssue, GitHubPullRequest, IssueToRelease, ReleaseNotesIssuesText } from './models';\nimport { classifyIssue } from './issueTypeClassifier';\nimport type { RestEndpointMethods } from '@octokit/plugin-rest-endpoint-methods/dist-types/generated/method-types';\n\nconst withUser = (issue) => issue.user;\nconst isMerged = (pullRequest) => Boolean(pullRequest.merged_at);\n\nconst issueToReleaseNoteText = (issue: IssueToRelease) =>\n  `- ${issue.title} ([#${issue.id}](${issue.url})) @${issue.user}`;\n\nexport const issuesToText = (issues: IssueToRelease[]): string =>\n  issues.map(issueToReleaseNoteText).join('\\n');\n\nconst toOthersText = (issues: IssueToRelease[]) =>\n  issues.length ? `\\nðŸ›  Others\\n--\\n\\n${issuesToText(issues)}\\n` : '';\n\nconst toBugsText = (issues: IssueToRelease[]) =>\n  issues.length ? `\\nðŸ› Bug Fixes\\n--\\n\\n${issuesToText(issues)}\\n` : '';\n\nconst toFeaturesText = (issues: IssueToRelease[]) =>\n  issues.length ? `\\nðŸš€ Features\\n--\\n\\n${issuesToText(issues)}\\n` : '';\n\nconst toEnhancementsText = (issues: IssueToRelease[]) =>\n  issues.length ? `\\nðŸ’„ Enhancements\\n--\\n\\n${issuesToText(issues)}\\n` : '';\n\nexport const toReleaseNoteText = ({\n  bugs,\n  features,\n  enhancements,\n  others,\n}: ReleaseNotesIssuesText) => `# What's changed\\n${bugs}${features}${enhancements}${others}`;\n\nconst toIssueToRelease = (issue: GitHubIssue): IssueToRelease => ({\n  id: issue.number,\n  title: issue.title,\n  url: issue.html_url,\n  user: issue.user!.login,\n  type: classifyIssue(issue),\n});\n\nconst fromPullRequestToIssueToRelease = (pullRequest: GitHubPullRequest): IssueToRelease => ({\n  id: pullRequest.number,\n  title: pullRequest.title,\n  url: pullRequest.html_url,\n  user: pullRequest.user!.login,\n  type: classifyIssue(pullRequest),\n});\n\nconst getClosedIssues = async (\n  github: any,\n  previousReleaseDate: string | null,\n  repo: string,\n  owner: string,\n): Promise<IssueToRelease[]> => {\n  const request: any = {\n    owner,\n    repo,\n    state: 'closed',\n  };\n\n  if (previousReleaseDate) {\n    request.since = previousReleaseDate;\n  }\n\n  const githubClosedIssues = await github.issues.listForRepo(request);\n  return githubClosedIssues.data.filter(withUser).map(toIssueToRelease);\n};\n\nconst getMergedPullRequest = async (\n  github: any,\n  previousReleaseDate: string | null,\n  repo: string,\n  owner: string,\n): Promise<IssueToRelease[]> => {\n  const request: any = {\n    owner,\n    repo,\n    state: 'closed',\n  };\n\n  if (previousReleaseDate) {\n    request.since = previousReleaseDate;\n  }\n\n  const githubPullRequestClosed = await github.pulls.list(request);\n  return githubPullRequestClosed.data\n    .filter(withUser)\n    .filter(isMerged)\n    .map(fromPullRequestToIssueToRelease);\n};\n\nexport const getLatestReleaseDate = async (\n  github: any,\n  repo: string,\n  owner: string,\n): Promise<string | null> => {\n  try {\n    const lastRelease = await github.repos.getLatestRelease({ owner, repo });\n    return lastRelease.data.published_at;\n  } catch (e: unknown) {\n    console.error(e);\n    return null;\n  }\n};\n\nexport const toReleaseNotesIssues = (\n  closedIssues: IssueToRelease[] = [],\n): ReleaseNotesIssuesText => {\n  const bugs: IssueToRelease[] = [];\n  const features: IssueToRelease[] = [];\n  const others: IssueToRelease[] = [];\n  const enhancements: IssueToRelease[] = [];\n\n  for (const issue of closedIssues) {\n    switch (issue.type) {\n      case 'feature':\n        features.push(issue);\n        break;\n      case 'bug':\n        bugs.push(issue);\n        break;\n      case 'test':\n        enhancements.push(issue);\n        break;\n      default:\n        others.push(issue);\n    }\n  }\n\n  return {\n    others: toOthersText(others),\n    bugs: toBugsText(bugs),\n    features: toFeaturesText(features),\n    enhancements: toEnhancementsText(enhancements),\n  };\n};\n\nexport const issuesToReleaseNotes = (issues: IssueToRelease[]): string => {\n  const releaseNotesIssuesText = toReleaseNotesIssues(issues);\n  return toReleaseNoteText(releaseNotesIssuesText);\n};\n\nexport const releaseNotes = async (\n  github: RestEndpointMethods,\n  repo: string,\n  owner: string,\n): Promise<string> => {\n  const previousReleaseDate = await getLatestReleaseDate(github, repo, owner);\n  const closedIssues = await getClosedIssues(github, previousReleaseDate, repo, owner);\n  const mergedPullRequests = await getMergedPullRequest(github, previousReleaseDate, repo, owner);\n  return issuesToReleaseNotes([...closedIssues, ...mergedPullRequests]);\n};\n","import * as core from '@actions/core';\nimport { Context } from '@actions/github/lib/context';\nimport { RestEndpointMethods } from '@octokit/plugin-rest-endpoint-methods/dist-types/generated/method-types';\n\nconst toTagName = (ref: string): string => {\n  const customTagName = core.getInput('TAG_NAME');\n  if (customTagName) {\n    return customTagName;\n  }\n  return ref.replace('refs/tags/', '');\n};\n\nexport const createRelease = async (\n  github: RestEndpointMethods,\n  context: Context,\n  notes: string,\n) => {\n  const {\n    ref,\n    repo: { repo, owner },\n  } = context;\n\n  const tagName = toTagName(ref);\n\n  const newRelease = await github.repos.createRelease({\n    owner,\n    repo,\n    tag_name: tagName,\n    name: `Release ${tagName}`,\n    body: notes,\n    draft: false,\n    prerelease: false,\n  });\n\n  const {\n    data: { id: releaseId, html_url: htmlUrl, upload_url: uploadUrl },\n  } = newRelease;\n\n  core.setOutput('id', releaseId);\n  core.setOutput('html_url', htmlUrl);\n  core.setOutput('upload_url', uploadUrl);\n};\n"],"mappings":"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","names":["core","context"]}